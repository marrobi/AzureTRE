#!/bin/bash
# Pre-commit hook to check for security vulnerabilities using Bandit
# This hook prevents commits that contain medium or higher severity security issues
# Works with both direct git hooks and pre-commit framework

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if Bandit is installed
if ! command -v bandit &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Bandit not found. Skipping security check.${NC}"
    echo -e "${YELLOW}Install with: pip install bandit${NC}"
    exit 0
fi

# Determine which files to check based on how the hook was called
if [ $# -eq 0 ]; then
    # Called as a git hook - get staged Python files
    echo -e "${BLUE}ðŸ” Running Bandit security check...${NC}"
    PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$')
else
    # Called by pre-commit framework - use arguments passed
    PYTHON_FILES="$@"
fi

if [ -z "$PYTHON_FILES" ]; then
    echo -e "${GREEN}âœ“ No Python files to check${NC}"
    exit 0
fi

# Show files being checked (only in verbose mode from git hook)
if [ $# -eq 0 ]; then
    echo -e "${BLUE}Files to check:${NC}"
    echo "$PYTHON_FILES" | sed 's/^/  - /'
fi

# Run Bandit and capture results
BANDIT_OUTPUT=$(bandit --severity-level medium $PYTHON_FILES 2>&1)
BANDIT_EXIT=$?

# Check if there were any findings (look for both exit code and issue output)
if [ $BANDIT_EXIT -ne 0 ] || echo "$BANDIT_OUTPUT" | grep -q ">> Issue:"; then
    ISSUE_COUNT=$(echo "$BANDIT_OUTPUT" | grep -c ">> Issue:" || echo "1")

    # Save report to constant location
    REPORT_FILE="/tmp/bandit-issues.txt"
    {
        echo "Bandit Security Report - $(date)"
        echo "=================================="
        echo ""
        echo "Please fix these Bandit security vulnerabilities, adhering to security best practices."
        echo ""
        echo "$BANDIT_OUTPUT"
    } > "$REPORT_FILE"

    echo ""
    echo -e "${YELLOW}ðŸ’¡ To resolve these vulnerabilities:${NC}"
    echo -e "${YELLOW}Review the prompt in: .github/prompts/bandit-fix.md${NC}"
    echo ""
    echo -e "${RED}âœ— Bandit found $ISSUE_COUNT security issue(s)${NC}"
    echo ""
    echo "$BANDIT_OUTPUT"
    echo ""
    echo -e "${RED}Commit aborted. Please fix the security vulnerabilities and try again.${NC}"
    exit 1
else
    echo -e "${GREEN}âœ“ No security vulnerabilities found${NC}"
    exit 0
fi
